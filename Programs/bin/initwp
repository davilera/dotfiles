#!/bin/bash

if [ ! -f .lando.yml ];
then
	echo "The current directory doesn't contain a ‘.lando.yml’ file" >&2
	exit 1
fi

PROJECT_NAME=`grep name .lando.yml | cut -d: -f2 | xargs`
SITE_NAME=`echo "$PROJECT_NAME" | sed -e "s/-/ /g" | sed "s/\b[a-z]/\u&/g"`
DIRNAME=`basename "$(pwd)"`

echo "Removing old image (if any)..."
echo 'y' | lando destroy >/dev/null 2>&1
rm -rf .lando >/dev/null 2>&1

echo "Creating environment..."
mkdir -p .lando/wordpress
echo "html_errors = 1" > .lando/php.ini
lando start >/dev/null 2>&1

echo "Initializing WordPress..."
echo "  - Downloading WP..."
lando wp core download --path=.lando/wordpress >/dev/null 2>&1

echo "  - Creating ‘wp-config.php’..."
lando wp config create --dbname=wordpress --dbuser=wordpress --dbpass=wordpress --dbhost="database.$PROJECT_NAME.internal" --path=.lando/wordpress >/dev/null 2>&1

echo "  - Installing WP..."
lando wp core install --url="http://$PROJECT_NAME.lndo.site" --title="$SITE_NAME" --admin_user=admin --admin_password=password --admin_email="admin@$PROJECT_NAME.lndo.site" --path=.lando/wordpress >/dev/null 2>&1

echo "Adding current project in WordPress installation..."
if [ `pwd | grep "/themes/" | wc -l` -eq 1 ];
then
	cd .lando/wordpress/wp-content/themes
	ln -s ../../../../ $DIRNAME
else
	cd .lando/wordpress/wp-content/plugins
	ln -s ../../../../ $DIRNAME
fi

echo "Done."
echo "It’s hammer time! (⌐■_■)"
