#!/usr/bin/bun
// vim: set filetype=javascript :

const { spawnSync } = require( 'child_process' );

const ESC = '\x1b';
const CTRL_C = '\x03';

main();
async function main() {
	const socket = process.env.KITTY_LISTEN_ON;

	const input = process.argv[ 2 ];
	const [ filename, line = 0 ] = input
		.split( ':' )
		.map( ( x, i ) => ( i === 1 ? Number.parseInt( x ) : x ) );

	const { stdout: info } = spawnSync( 'kitty', [
		'@',
		'ls',
		'--to',
		socket,
	] );
	const win = JSON.parse( info ).find( ( w ) => w.is_focused );
	if ( ! win ) {
		process.exit( 1 );
	}

	const currentTab = win.tabs.find( ( t ) => t.is_focused );
	const cwd = currentTab.windows[ 0 ]?.cwd;
	if ( ! cwd ) {
		process.exit( 1 );
	}

	const vimTab = win.tabs.find( isTabRunning( cwd, 'nvim' ) )?.id;
	if ( vimTab ) {
		await openInVim( vimTab, filename, line );
		process.exit( 0 );
	}

	await openInNewVim( win, cwd, filename, line );
	process.exit( 0 );
}

// =======
// HELPERS
// =======

function isTabRunning( cwd, targetProgram ) {
	return ( t ) => {
		const process = t.windows[ 0 ]?.foreground_processes[ 0 ];
		if ( process?.cwd !== cwd ) {
			return false;
		}

		const cmdline = process?.cmdline[ 0 ];
		if (
			cmdline !== targetProgram &&
			! cmdline.includes( `/${ targetProgram }` )
		) {
			return false;
		}

		return true;
	};
}

async function sleep( time ) {
	await new Promise( ( r ) => setTimeout( r, time ) );
}

async function openInVim( vimTab, filename, line ) {
	const socket = process.env.KITTY_LISTEN_ON;
	spawnSync( 'kitty', [
		'@',
		'focus-tab',
		'--to',
		socket,
		`--match=id:${ vimTab }`,
	] );
	await sleep( 50 );
	spawnSync( 'kitty', [
		'@',
		'send-text',
		'--to',
		socket,
		`--match-tab=id:${ vimTab }`,
		`${ ESC }:ed +${ line } ${ filename }\n`,
	] );
}

async function openInNewVim( win, cwd, filename, line ) {
	const socket = process.env.KITTY_LISTEN_ON;
	const id =
		win.tabs.find( isTabRunning( cwd, 'bash' ) )?.id || openTab( cwd );
	spawnSync( 'kitty', [
		'@',
		'focus-tab',
		'--to',
		socket,
		`--match=id:${ id }`,
	] );
	await sleep( 1000 );
	spawnSync( 'kitty', [
		'@',
		'send-text',
		'--to',
		socket,
		`--match-tab=id:${ id }`,
		`${ CTRL_C } nvim +${ line } ${ filename }\n`,
	] );
}

function openTab( cwd ) {
	const socket = process.env.KITTY_LISTEN_ON;
	const { stdout } = spawnSync( 'kitty', [
		'@',
		'launch',
		'--to',
		socket,
		'--type=tab',
		'--location=neighbor',
		'--keep-focus',
		`--cwd=${ cwd }`,
	] );
	return JSON.parse( stdout );
}
